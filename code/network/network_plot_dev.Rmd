---
title: "Network"
author: "Emi"
output: 
  html_document:
    code_folding: hide
    number_sections: true
---

```{=html}
<style type="text/css">
  .main-container {
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
```

If you want to save this code together with the output, mody this file, save it and then run (call) it from 'Rutils\Rmarkdown_dynamic_filename.R'. Path is 'code/network/network_plot_dev.Rmd'

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/')
library(tidyverse)
library(lubridate)
library("igraph", quietly = TRUE, warn.conflicts = FALSE, verbose = FALSE)
library(tidygraph) # Plotting graphs
library(ggraph)
require(visNetwork)
library(svglite) # export plots to svg
source('C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/code/Rutils/Emi_R_utils.R')

plots <- list('banksLinks'=NULL, 'linksWeights'=NULL, 
          'fullNetwork'=NULL, 'networkFailBanks'=NULL)
specs <- list('savingFolder'='data/SAMS/', 
              'idSample'= 'n80_fs98q4_ft01q4_Lag4_logAssets_Wrest_sample')

```

---
  date: `r today()`
---

# Load network data
```{r load_network}
Wig <- readRDS(paste0(specs$savingFolder, specs$idSample, '.rds'))$network
network <- Wig %>%
  as_tbl_graph() %>%
  activate(nodes) %>%
  rename('IDENT' = 'name') %>%
  rename('label' = 'B_NAME') %>%
  mutate(degree = degree(.),
         colour = if_else(failure==1, 'red', 'green'),
         value = ActivoN_L4, 
         title = str_c(label, ', $ ', (ActivoN_L4), ' log of.'),
         B_SIZE = ActivoN_L4)
network <- network %>%
            activate(edges) %>%
            mutate('WEIGHT' = WEIGHT/100)

summary(network)
```

## Distribution of entities (nodes)

* There are 
How many entities as lenders?

## Distribution of links
```{r}
network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(from) %>% NROW()

network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(to) %>% NROW()


plots$banksLinks <- network %>%
  activate(nodes) %>%
  as_tibble(.) %>%
  {ggplot(., mapping=aes(x=degree)) +
  geom_histogram(binwidth=3, fill='blue') +
      scale_x_continuous(name='Number of links by entitiy (degree)') +
      scale_y_continuous(name='Number of entities', breaks=0:10) +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$banksLinks

```
## Distribution of weights
```{r}
plots$linksWeights <- network %>%
  activate(edges) %>%
  as_tibble(.) %>%
  { ggplot(., mapping=aes(x=WEIGHT)) +
      geom_histogram(binwidth=1, colour='grey') +
      scale_x_continuous(name='Link weight as percentage of Loans', breaks=0:20) +
      scale_y_continuous(name='Number of links') +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$linksWeights
```


# Network plot


```{r}
networkFplot <- network %>%
  activate(edges) %>%
  filter(., WEIGHT>0.1)

#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_hive(pNetwork)

plots$fullNetwork <- networkFplot %>%
  ggraph(., layout = 'kk') +
  geom_edge_fan2(aes(alpha = WEIGHT), colour='black', check_overlap=TRUE, n = 115) + 
    geom_node_point(aes(size=B_SIZE), shape=21, fill=V(networkFplot)$colour) +
  theme_graph()

plots$fullNetwork
  
```


```{r }
WigFails  <- networkFplot %>%
  activate(nodes) %>%
  filter(., failure==1) 

WigFails

```
Which failing banks are isolated?
```{r}
WigFails %>% activate(nodes) %>% 
  filter(node_is_isolated())

```

                    
```{r plot_fail_banks_network}

plots$WigFails <- WigFails %>%
  {ggraph(., layout = 'kk') +
  geom_edge_fan2(aes(alpha = WEIGHT), colour='black', check_overlap=TRUE, n = 115, show.legend = FALSE) + 
  geom_node_point(aes(size=B_SIZE), shape=21, fill=V(.)$colour, show.legend=FALSE) +
      theme_graph()}
    
plots$NetworkFailBanks

```

# Save
```{r save, eval=FALSE, include=FALSE}
walk2(plots, names(plots), function(plot, fileName) {
  ggsave(paste0(specs$savingFolder, fileName, '.pdf'),
         plot, 
   width=22.5, height=15, units='cm')
})

```


## Interactive plot

Using visNetwork package. I use the same 'g' object from iGraph

```{r plot_interactive, eval=FALSE, include=FALSE}
# This does not work because as_tbl_graph() has sequential IDs in the edges tibble but the original bank IDs in the nodes tibble

pTblNodes <- network %>%
  activate(nodes) %>%
  rename('id'='IDENT') %>%
  as_tibble() %>%
  select(., id)

pTblRelations <- network %>%
  activate(edges) %>%
  as_tibble()

visNetwork(pTblNodes, pTblRelations, width = "100%") %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE)


```


```{r}
#visIgraph(network)
# Provde the initial igraph network rather than tidygraph.IDgraphs names edges with sequential IDs. Tidygraph breaks the association between IDs.
visNetData <- toVisNetworkData(netIg)
visNetData$nodes <- visNetData$nodes %>%
                      mutate('value' = B_SIZE,
                      'group' = if_else(as.logical(survival), 'survivors', 'failing'),
                      'label' = NOMRED)
visNetData$edges <- visNetData$edges %>%
                      mutate('value' = WEIGHT)

visNetwork(nodes=visNetData$nodes, edges=visNetData$edges, width = '100%') %>%
  visNodes(scaling = list('min'=40, 'max'=80)) %>%
  visEdges(color = list('color'='grey', 'opacity'=0.4)) %>%
  visGroups(groupname = 'survivors', color=list('background'='yellow', 'border'='black')) %>%
  visGroups(groupname = 'failing', color=list('background'='red', 'border'='black')) %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based", 
            forceAtlas2Based = list(gravitationalConstant = -1000))

```





