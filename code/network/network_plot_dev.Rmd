---
title: "Network"
author: "Emi"
output: 
  html_document:
    code_folding: hide
    number_sections: true
---

```{=html}
<style type="text/css">
  .main-container {
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
```

If you want to save this code together with the output, mody this file, save it and then run (call) it from 'Rutils\Rmarkdown_dynamic_filename.R'. Path is 'code/network/network_plot_dev.Rmd'

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/')
library(readxl)
library(tidyverse)
library(lubridate)
library("igraph", quietly = TRUE, warn.conflicts = FALSE, verbose = FALSE)
library(tidygraph) # Plotting graphs
library(ggraph)
require(visNetwork)
library(svglite) # export plots to svg
source('C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/code/Rutils/Emi_R_utils.R')
```

---
  date: `r today()`
---
# Specs
```{r}
specs <- list('idSample' = 'A99_pastAvgW_creW_b97q4_s03q4',
              'savingFolder' = 'output/SAR/Annual99_pastAvgW/',
'y' = list('failureSince' = 2000.1,
                         'failureHorizon' = 2003.4),
              'X' = list('freq' = 'annual',
                         'from' = 1999,
                         'to' = 1999,
                         'bankBirthFrom' = 1997.4, 
                         'vars' = c('ActivoN', 'C8Est_w', 'CAR_IRR_3A6', 'P_ROA', 'P_DEP_ARS_RATE',
                                    'P_LOANS_ARS_RATE_W', 'APRSpNF_RATE_W', 'APR_USD_RATE', 'APR_RATE_W')),
              'W' = list('from' = '',
                         'to' = '1998q4',
                         #Weights from debtor/creditor perspective : W_D_PR/W_A_PR (Deudora / Acreeedora)
                         'wVar' = 'W_A_PR'))

plots <- list('banksLinks'=NULL, 'linksWeights'=NULL, 
          'fullNetwork'=NULL, 'networkFailBanks'=NULL)

```

# Load network data
```{r load_network}
setwd('C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/')

banksDB <- haven::read_dta('data/BAFAannual/failures-1997-2001-annual.dta') %>%
  dplyr::mutate(., 
                fechaQ = quarter(as_date(FECHA_D, origin=ymd('1960-01-01')), with_year=TRUE),
                exitDateQ = quarter(as_date(EXIT_DATE, origin=ymd('1960-01-01')), with_year=TRUE),
                startDateQ = quarter(as_date(FIRST_DATE, origin=ymd('1960-01-01')), with_year=TRUE),
                .after = IDENT) 

banks <- banksDB %>%
  drop_na %>%
  filter(FECHA_A == specs$X$from) %>%
  # ONly private banks
  filter(GRUPO_ID_UNI != 4 & GRUPO_ID_UNI !=5) %>%
  filter(startDateQ<= !!specs$X$bankBirthFrom & exitDateQ >= !!specs$y$failureSince)  %>%
  mutate('FAIL' = if_else(exitDateQ<=specs$y$failureHorizon, 1, 0),
         'NAME' = as.character(IDENT)) %>%
  select(., NAME, NOMRED, ActivoN, FAIL)

Wtb <- read_excel(paste0(specs$savingFolder,'avgRelations.xlsx'))
#Wig <- readRDS(paste0(specs$savingFolder, specs$idSample, '.rds'))$network
network <- Wtb %>%
  as_tbl_graph() %>%
  activate(nodes) %>%
  rename('NAME' = 'name') %>%
  right_join(., banks, by='NAME') %>%
  mutate(degree = degree(.),
         colour = if_else(FAIL==1, 'red', 'green'),
         value = ActivoN, 
         #title = str_c(label, ', $ ', (ActivoN), ' log of.'),
         'Assets' = ActivoN/1000000)
network <- network %>%
            activate(edges) %>%
            mutate('Weight (%)' = WEIGHT)

summary(network)
```

## Distribution of entities (nodes)

* There are 
How many entities as lenders?

## Distribution of links
```{r}
network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(from) %>% NROW()

network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(to) %>% NROW()


plots$banksLinks <- network %>%
  activate(nodes) %>%
  as_tibble(.) %>%
  {ggplot(., mapping=aes(x=degree)) +
  geom_histogram(binwidth=3, fill='blue') +
      scale_x_continuous(name='Number of links by entitiy (degree)') +
      scale_y_continuous(name='Number of entities', breaks=0:10) +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$banksLinks

```
## Distribution of weights
```{r}
plots$linksWeights <- network %>%
  activate(edges) %>%
  as_tibble(.) %>%
  { ggplot(., mapping=aes(x=`Weight (%)`)) +
      geom_histogram(binwidth=1, colour='grey') +
      scale_x_continuous(name='Link weight as percentage of Loans', breaks=0:20) +
      scale_y_continuous(name='Number of links') +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$linksWeights

ggsave(paste0(specs$savingFolder, 'linksWeights.pdf'), plots$linksWeights,
       width=22.5, height=15, units='cm')
```


# Network plot


```{r}
networkFplot <- network %>%
  activate(edges) 
  #filter(., WEIGHT>0.1)

#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_hive(pNetwork)

plots$fullNetwork <- networkFplot %>%
  ggraph(., layout = 'kk') +
  geom_edge_fan2(aes(alpha = `Weight (%)`), colour='black', check_overlap=TRUE, n = 115) + 
  geom_node_point(aes(size=Assets), shape=21, fill=V(networkFplot)$colour) +
  theme_graph() +
  theme(legend.position = 'bottom')

plots$fullNetwork

```


```{r }
WigFails  <- networkFplot %>%
  activate(nodes) %>%
  filter(., FAIL==1) 

WigFails

```
Which failing banks are isolated?
```{r}
WigFails %>% 
  activate(nodes) %>% 
  filter(node_is_isolated())

```

                    
```{r plot_fail_banks_network}

plots$WigFails <- networkFplot %>%
  activate('edges') %>%
  mutate(`Weight (%)` = WEIGHT * (.N()$FAIL[from] + .N()$FAIL[to] )) %>%
  ggraph(., layout = 'kk') +
  geom_edge_fan2(aes(filter=`Weight (%)`>0, alpha = `Weight (%)`),colour='black',
                 check_overlap=TRUE, n = 115) + 
  geom_node_point(aes(size=Assets), shape=21, fill=V(networkFplot)$colour) +
  theme_graph() +
  theme(legend.position = 'bottom')


```

# Save
```{r save, eval=FALSE, include=FALSE}
walk2(plots, names(plots), function(plot, fileName) {
  ggsave(paste0(specs$savingFolder, fileName, '.jpeg'),
         plot, 
   width=22.5, height=15, units='cm')
})

```


## Interactive plot

Using visNetwork package. I use the same 'g' object from iGraph

```{r plot_interactive, eval=FALSE, include=FALSE}
# This does not work because as_tbl_graph() has sequential IDs in the edges tibble but the original bank IDs in the nodes tibble

pTblNodes <- network %>%
  activate(nodes) %>%
  rename('id'='IDENT') %>%
  as_tibble() %>%
  select(., id)

pTblRelations <- network %>%
  activate(edges) %>%
  as_tibble()

visNetwork(pTblNodes, pTblRelations, width = "100%") %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE)


```


```{r}
#visIgraph(network)
# Provde the initial igraph network rather than tidygraph.IDgraphs names edges with sequential IDs. Tidygraph breaks the association between IDs.
visNetData <- toVisNetworkData(netIg)
visNetData$nodes <- visNetData$nodes %>%
                      mutate('value' = B_SIZE,
                      'group' = if_else(as.logical(survival), 'survivors', 'failing'),
                      'label' = NOMRED)
visNetData$edges <- visNetData$edges %>%
                      mutate('value' = WEIGHT)

visNetwork(nodes=visNetData$nodes, edges=visNetData$edges, width = '100%') %>%
  visNodes(scaling = list('min'=40, 'max'=80)) %>%
  visEdges(color = list('color'='grey', 'opacity'=0.4)) %>%
  visGroups(groupname = 'survivors', color=list('background'='yellow', 'border'='black')) %>%
  visGroups(groupname = 'failing', color=list('background'='red', 'border'='black')) %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based", 
            forceAtlas2Based = list(gravitationalConstant = -1000))

```





