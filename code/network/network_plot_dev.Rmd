---
title: "Network desc stats from sample"
author: "Emi"
output: 
  html_document:
    code_folding: hide
    number_sections: true
params:
    IDSAM: "A98_W98und_B2L_nz_99FT01q3"
---

```{=html}
<style type="text/css">
  .main-container {
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
```
If you want to save this code together with the output, mody this file, save it and then run (call) it from 'Rutils\Rmarkdown\_dynamic_filename.R'. Path is 'code/network/network_plot_dev.Rmd'

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = 'C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/')
library(readxl)
library(tidyverse)
library(lubridate)
library("igraph", quietly = TRUE, warn.conflicts = FALSE, verbose = FALSE)
library(tidygraph) # Plotting graphs
library(ggraph)
library(readODS)
require(visNetwork)
library(svglite) # export plots to svg
source('../Rutils/Emi_R_utils.R')
```

---
  date: `r today()`
---

# Load network data from sample

```{r load_network}
#setwd('C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/')

samID <- str_trim(params$IDSAM, side='both') %>% str_split(., " ", simplify=TRUE) %>% .[1,]

samSpecs <- read_ods("../../data/sams_specs_BAFA.ods") %>%
  filter(IDSAM %in% samID) %>%
  # how should results be ordered? useful for tables
  mutate(order = match(.$IDSAM, samID)) %>%
  arrange(., order)

if(NROW(samSpecs) == 0) { stop(paste("sams: ", samID, " not found!"))}
# Vars to reescale
cols <- c('C8Est_w', 'CAR_IRR_3A6', 'P_ROA', 'P_DEP_ARS_RATE', 'P_LOANS_ARS_RATE_W', 
'APRSpNF_RATE_W', 'APR_USD_RATE', 'APR_RATE_W')

Sams <- pmap(samSpecs, function(...) {
  thisSamSpec <- tibble(...)
  fileName <- paste0('../../', thisSamSpec$SAMSAVINGFOLDER, thisSamSpec$IDSAM, '.rds') 
  print(paste0("Opening ", fileName))
  thisSam <- readRDS(fileName)
}) 
#Wig <- readRDS(paste0(specs$savingFolder, specs$idSample, '.rds'))$network
network <- Sams[[1]]$G %>%
  as_tbl_graph() %>%
  activate(nodes) %>%
  #rename('NAME' = 'name') %>%
  #right_join(., banks, by='NAME') %>%
  mutate(in_degree = degree(., mode='in'),
         out_degree = degree(., mode='out'),
         colour = if_else(failure==1, 'red', 'green'),
         value = ActivoN, 
         #title = str_c(label, ', $ ', (ActivoN), ' log of.'),
         'Assets' = ActivoN/1000000)

# REname weight attribute
if (samSpecs$W.WEIGHTED) {
  network <- network %>%
            activate(edges) %>%
            mutate('Weight (%)' = weight)
}

summary(network)
```

## Distribution of entities (nodes)

## Distribution of links

```{r}
nBorrowers <- network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(from) %>% NROW()

nLenders <- network %>%
  activate(edges) %>%
  as_tibble() %>%
  count(to) %>% NROW()



#if(samSpecs$W.WVAR == "W_A_PR") { 
#  B2L = TRUE # borrower to lender
#} else {
#    B2L = FALSE}
#thisXLabel = if_else(B2L, 
#                     "", 
#                     "Number of outgoing links by entity (out degree)")
```

-   There are `r nBorrowers` borrowers and `r nLenders` lenders. They could be the same

```{r in_links}

plots <- list()
plots$inLinks <- network %>%
  activate(nodes) %>%
  as_tibble(.) %>%
  {ggplot(., mapping=aes(x=in_degree)) +
  geom_histogram(binwidth=2, fill='blue') +
      scale_x_continuous(name='Number of incoming links by entity (in degree)', breaks=seq(from=0, to=50, by=5)) +
      scale_y_continuous(name='Number of entities', breaks=seq(from=0, to=25, by=4)) +
      coord_cartesian(xlim=c(0, 50), ylim=c(0, 25)) +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$inLinks

```

```{r out_links}
plots$outLinks <- network %>%
  activate(nodes) %>%
  as_tibble(.) %>%
  {ggplot(., mapping=aes(x=out_degree)) +
  geom_histogram(binwidth=2, fill='blue') +
      scale_x_continuous(name='Number of outgoing links by entity (out degree)', breaks=seq(from=0, to=50, by=5)) +
      scale_y_continuous(name='Number of entities', breaks=seq(from=0, to=25, by=4)) +
      coord_cartesian(xlim=c(0, 50), ylim=c(0, 25)) +
      theme_bw() +
      theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                     panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                     axis.text.x = element_text(),
                     axis.text.y = element_text(size=14),
                     legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}

plots$outLinks
```

## Distribution of weights

```{r}
if (samSpecs$W.WEIGHTED) {
  centerWeight <- network %>%
    activate(edges) %>% as_tibble() %>% 
    { c(mean(.$weight), median(.$weight))}
} else {
  centerWeight <- c(NA,NA)
}
```

The mean of weight is **`r centerWeight[1]`** while the median weight is **`r centerWeight[2]`**

```{r}
if (samSpecs$W.WEIGHTED) {
  
  plots$linksWeights <- network %>%
    activate(edges) %>%
    as_tibble(.) %>%
    { ggplot(., mapping=aes(x=`Weight (%)`)) +
        geom_histogram(binwidth=0.5, colour='grey') +
        scale_x_continuous(name='Link weight as percentage of Loans', breaks=0:20) +
        scale_y_continuous(name='Number of links') +
        theme_bw() +
        theme(panel.grid=element_line(colour='#999999', linetype='14'), 
                       panel.grid.minor=element_line(colour='white'), text=element_text(size=16), 
                       axis.text.x = element_text(),
                       axis.text.y = element_text(size=14),
                       legend.position = 'bottom', legend.key.height=unit(3.5, 'cm'))}
  
  plots$linksWeights
}

```

# Failed subnetwork

```{r}
networkF <-  network %>%
  activate(nodes) %>%
  filter(failure == 1)
# Nodes
V(networkF)

# List the in-degree for each node
E(networkF)
```

## Links between failing banks

Between 1999q1 and 2001q3, 23 local-private banks failed, see file:///C:/Users/emi/OneDrive/UWA%20PhD/bankFailure/code/descStats/desc_stats_dev.html#how-many-local-private-banks-failed

Count how many failed banks had an incoming link from another fail one. 
Count in-degree (lenders)
```{r}
nIncLinks <- degree(networkF, mode='in')
nIncLinks[nIncLinks > 0]
```
There are `r length(nIncLinks[nIncLinks > 0])` failed banks with links with another failed one. 
Is this network DIRECTED? `r samSpecs$W.DIRECTED`

## Failed subnetwork plot

```{r}
networkFplot <- networkF %>%
  activate(edges) 
  #filter(., WEIGHT>0.1)

#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_with_lgl(pNetwork, options=list(fixed=))
#thisLayout <- layout_hive(pNetwork)

plots$networkF <- networkFplot %>%
  ggraph(., layout = 'kk') +
  geom_node_point(aes(size=Assets), shape=21, fill=V(networkFplot)$colour) +
  geom_node_label(aes(label=NOMRED), repel=TRUE, alpha=0.5, size=2) +
  theme_graph(base_family = "sans") +
  theme(legend.position = 'bottom')
if(samSpecs$W.WEIGHTED) {
  plots$networkF <- plots$networkF +
  geom_edge_fan2(aes(alpha = `Weight (%)`), colour='black', check_overlap=TRUE, n = 115)
} else {
  plots$networkF <- plots$networkF +
  geom_edge_fan2( colour='black', check_overlap=TRUE, n = 115)
}

plots$networkF

```

```{r }
WigFails  <- networkFplot %>%
  activate(nodes) %>%
  filter(., failure==1) 

WigFails

```

Which failing banks are isolated?

```{r}
WigFails %>% 
  activate(nodes) %>% 
  filter(node_is_isolated())

```

```{r plot_fail_banks_network, eval=FALSE, include=FALSE}

plots$WigFails <- networkFplot %>%
  activate('edges') %>%
  mutate(`Weight (%)` = weight * (.N()$failure[from] + .N()$failure[to] )) %>%
  ggraph(., layout = 'kk') +
  geom_edge_fan2(aes(filter=`Weight (%)`>0, alpha = `Weight (%)`),colour='black',
                 check_overlap=TRUE, n = 115) + 
  geom_node_point(aes(size=Assets), shape=21, fill=V(networkFplot)$colour) +
  theme_graph(base_family = "sans") +
  theme(legend.position = 'bottom')

plots$WigFails
```

# Save

```{r save, eval=TRUE, include=TRUE}
fileNames <- paste0('../../output/network/', samSpecs$IDSAM, '-',  names(plots), '.jpeg')
walk2(plots, fileNames, function(plot, fileName) {
  ggsave(fileName,
         plot, 
   width=22.5, height=15, units='cm')
})

```

# INTERACTIVE PLOT

Using visNetwork package. I use the same 'g' object from iGraph

```{r plot_interactive, eval=FALSE, include=FALSE}
# This does not work because as_tbl_graph() has sequential IDs in the edges tibble but the original bank IDs in the nodes tibble

pTblNodes <- network %>%
  activate(nodes) %>%
  rename('id'='IDENT') %>%
  as_tibble() %>%
  select(., id)

pTblRelations <- network %>%
  activate(edges) %>%
  as_tibble()

visNetwork(pTblNodes, pTblRelations, width = "100%") %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visEdges(arrows = "to") %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE)


```

```{r}
#visIgraph(network)
# Provde the initial igraph network rather than tidygraph.IDgraphs names edges with sequential IDs. Tidygraph breaks the association between IDs.
visNetData <- toVisNetworkData(Sams[[1]]$G)
visNetData$nodes <- visNetData$nodes %>%
                      mutate('value' = ActivoN,
                      'group' = if_else(as.logical(failure), 'failures', 'survivors'),
                      'label' = NOMRED)
if (samSpecs$W.WEIGHTED) {
  visNetData$edges <- visNetData$edges %>%
                      mutate('value' = weight)
}

visNetwork(nodes=visNetData$nodes, edges=visNetData$edges, width = '100%') %>%
  visNodes(scaling = list('min'=40, 'max'=80)) %>%
  visEdges(color = list('color'='grey', 'opacity'=0.4), arrows='to') %>%
  visGroups(groupname = 'survivors', color=list('background'='yellow', 'border'='black')) %>%
  visGroups(groupname = 'failures', color=list('background'='red', 'border'='black')) %>%
  visLayout(randomSeed = 123, improvedLayout=TRUE) %>%
  visOptions(height='800px', highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visConfigure(enabled = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based", 
            forceAtlas2Based = list(gravitationalConstant = -1000))

```
