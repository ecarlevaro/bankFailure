---
title: "Banks DB descStats"
author: "Emi"
date: "30/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(haven)
library(tidyverse)
library(lubridate)
library(xlsx)
library(DT)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r db}
db <- haven::read_dta('C:/Users/emi.ABLE-22868/OneDrive/UWA PhD/bankFailure/data/DBbanks/failures-allEnts-1997-2004.dta',
         col_select = FECHAdata:saldo111001) %>%
        dplyr::mutate(., FECHAdata = ymd("1960-01-01")+months(FECHAdata))
#summary(cars)
```

# Descriptive statistics
## From 1997-12 to 2001-12
### Missing values as %
```{r mssingByYear}
db %>% 
  filter(FECHAdata>=ymd("1997-12-1") & FECHAdata<=ymd("2001-12-31")) %>%
  group_by(FECHAdataAnio) %>%
    summarise(across(c(ActivoN, C8Est_w, CAR_IRR_3A6, P_ROA, P_DEP_ARS_RATE, P_LOANS_ARS_RATE_W, APRSpNF_RATE_W, APR_USD_RATE, APR_RATE_W), 
                   list(M = ~round(( sum(is.na(.x))/sum(!is.na(IDent)))*100)) )) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)
```

### Desc stats table
```{r desc_stats_table}
tibble('id' = c(1,2,3),
  'var1' = c(100,225, 300)) %>%
  summarize(across(c(var1), 
                   list(mean = mean)))

varsList <- c('ActivoN', 'C8Est_w', 'CAR_IRR_3A6', 'P_ROA', 'P_DEP_ARS_RATE', 'P_LOANS_ARS_RATE_W', 'APRSpNF_RATE_W', 'APR_USD_RATE', 'APR_RATE_W')
dSVals <- db %>% 
  filter(FECHAdata>=ymd("1997-12-1") & FECHAdata<=ymd("2001-12-31")) %>%
  summarise(across(all_of(varsList), list(
    'min' = ~min(.x, na.rm=TRUE),
    'median' = ~round(median(.x, na.rm=TRUE)),
    'mean' = ~mean(.x, na.rm=TRUE),
    'max' = ~round(max(.x, na.rm=TRUE)),
    'SD' = ~round(sd(.x, na.rm=TRUE))
    )))

colName = c('min', 'median', 'mean', 'sd', 'max')
out <- map_dfc(colName, function(colName) {
  
 colVector <- select(dSVals, ends_with(colName)) %>%
  map_dbl(., function(col) { 
    as_vector(col)
    round(col, digits=2) 
    })
})
  
descStatsTibble <- tibble('min' = as_vector(select(dSVals, ends_with('min'))),
                    'median' = as_vector(select(dSVals, ends_with('median'))),
                    'mean' = as_vector(select(dSVals, ends_with('mean'))),
                    'sd' = as_vector(select(dSVals, ends_with('sd'))),
                    'max' = as_vector(select(dSVals, ends_with('max'))))
rownames(descStatsTibble) <- vars
  datatable(descStatsTibble) %>%
    formatRound(columns=c('min', 'median', 'mean', 'sd', 'max'))
```

                        mean = ~round(mean(.x, na.rm=TRUE)),
                        median = ~round(median(.x, na.rm=TRUE)),
                        max = ~round(max(.x)),
                        SD = ~round(sd(.x, na.rm=TRUE))
                        
## Details
### Results
#### ActivoN

```{r Activo, results='asis'}
db %>% 
  group_by(IDent) %>%
  summarise(across(c(ActivoN), 
                   list('min' = min,
                        mean = ~mean(.x, na.rm=TRUE),
                        max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)


```

#### Equity ratio

```{r Equity, results='asis'}
db %>%
  summarise(across(c(C8_E, C8Est_w),
                   list(mean = ~mean(.x, na.rm=TRUE),
                        sd = ~sd(.x, na.rm=TRUE))))

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(C8_E, C8Est_w), 
                   list('min' = min,
                        mean = ~mean(.x, na.rm=TRUE),
                        max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)

# By IDent
db %>% 
  group_by(IDent) %>%
  summarise(across(c(C8_E, C8Est_w), 
                   list(mean = ~mean(.x, na.rm=TRUE),
                        sd = ~sd(.x, na.rm=TRUE),
                        N_MISSING = ~sum(is.na(.x))))) %>%
  datatable(.)
```

C8Est_w has lower sd.

#### Non-performing loans

CAR_IRR_3A6
```{r Nonperforming, results='asis'}
db %>%
  summarise(across(c(CAR_IRR_3A6),
                   list(mean = ~mean(.x, na.rm=TRUE),
                        sd = ~sd(.x, na.rm=TRUE))))

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(CAR_IRR_3A6), 
                   list('min' = min,
                        mean = ~mean(.x, na.rm=TRUE),
                        max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)

# By IDent
db %>% 
  group_by(IDent) %>%
  summarise(across(c(C8_E, C8Est_w), 
                   list(mean = ~mean(.x, na.rm=TRUE),
                        sd = ~sd(.x, na.rm=TRUE),
                        N_MISSING = ~sum(is.na(.x))))) %>%
  datatable(.)
```


#### ROA
```{r ROA, results='asis'}
db %>%
  summarise(across(c(P_ROA, P_ROA_EST_PC),
                   list(mean = ~mean(.x, na.rm=TRUE),
                        sd = ~sd(.x, na.rm=TRUE))))

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(P_ROA, P_ROA_EST_PC), 
                   list(#'min' = min,
                        mean = ~round(mean(.x, na.rm=TRUE),2),
                        #max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)

# By IDent
db %>% 
  group_by(IDent) %>%
  summarise(across(c(P_ROA, P_ROA_EST_PC), 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  #summarise(., meanMissing = mean(P_ROA_N_MISSING))
  summarise(., across(c(P_ROA_N_MISSING, P_ROA_EST_PC_N_MISSING), 
                      list(meanMissing = ~mean(.x)))) %>%
  datatable(.)

db %>% 
  filter(FECHAdataAnio<2002) %>%
  group_by(IDent) %>%
  summarise(across(c(P_ROA, P_ROA_EST_PC), 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  #summarise(., meanMissing = mean(P_ROA_N_MISSING))
  summarise(., across(c(P_ROA_N_MISSING, P_ROA_EST_PC_N_MISSING), 
                      list(meanMissing = ~mean(.x)))) %>%
  datatable(.)

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(P_ROA, 
                   list('min' = ~round(min(.x, na.rm = TRUE), 2),
                        'mean' = ~round(mean(.x, na.rm=TRUE),2),
                        'median' = ~round(median(.x, na.rm=TRUE),2),
                        'sd' = ~round(sd(.x, na.rm=TRUE),2),
                        'max' = ~round(max(.x, na.rm = TRUE)),
                        'N_MISSING' = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)
```

#### Public sector expoure

```{r StateExp, results='asis'}
db %>%
  summarise(across(c(APRSpNF_RATE_W),
                   list(mean = ~round(mean(.x, na.rm=TRUE), 2),
                        sd = ~round(sd(.x, na.rm=TRUE), 2))))

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(APRSpNF_RATE_W), 
                   list(#'min' = min,
                        mean = ~round(mean(.x, na.rm=TRUE),2),
                        #max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)

# By IDent
db %>% 
  group_by(IDent) %>%
  summarise(across(APRSpNF_RATE_W, 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  #summarise(., meanMissing = mean(P_ROA_N_MISSING))
  summarise(., across(c(APRSpNF_RATE_N_MISSING), 
                      list(meanMissing = ~mean(.x)))) %>%
  datatable(.)


db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(APRSpNF_RATE_W), 
                   list('min' = ~round(min(.x, na.rm = TRUE), 2),
                        'mean' = ~round(mean(.x, na.rm=TRUE),2),
                        'median' = ~round(median(.x, na.rm=TRUE),2),
                        'sd' = ~round(sd(.x, na.rm=TRUE),2),
                        'max' = ~round(max(.x, na.rm = TRUE)),
                        'N_MISSING' = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)
```
```{r interest_rates}
db %>%
  summarise(across(c(APRSpNF_SHR),
                   list(mean = ~round(mean(.x, na.rm=TRUE), 2),
                        sd = ~round(sd(.x, na.rm=TRUE), 2))))

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(APRSpNF_SHR), 
                   list(#'min' = min,
                        mean = ~round(mean(.x, na.rm=TRUE),2),
                        #max = max,
                        N_MISSING = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)

# By IDent
db %>% 
  group_by(IDent) %>%
  summarise(across(APRSpNF_SHR, 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  #summarise(., meanMissing = mean(P_ROA_N_MISSING))
  summarise(., across(c(APRSpNF_SHR_N_MISSING), 
                      list(meanMissing = ~mean(.x)))) %>%
  datatable(.)


db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(APRSpNF_SHR), 
                   list('min' = ~round(min(.x, na.rm = TRUE), 2),
                        'mean' = ~round(mean(.x, na.rm=TRUE),2),
                        'median' = ~round(median(.x, na.rm=TRUE),2),
                        'sd' = ~round(sd(.x, na.rm=TRUE),2),
                        'max' = ~round(max(.x, na.rm = TRUE)),
                        'N_MISSING' = ~sum(is.na(.x))))) %>%
  #filter(., Activo_N_MISSING > 0) %>%
  #kable(., caption='Missinv values for Activo')
  datatable(.)
### Missing values
```{r missValues, results='asis'}
db %>% 
  summarise(across(c(ActivoN, C8Est_w, CAR_IRR_3A6), 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  datatable(.)

db %>% 
  group_by(FECHAdataAnio) %>%
  summarise(across(c(ActivoN, C8Est_w, CAR_IRR_3A6), 
                   list(N_MISSING = ~sum(is.na(.x))))) %>%
  datatable(.)

```
